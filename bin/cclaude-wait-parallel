#!/usr/bin/env bash
###############################################################################
# cclaude-wait-parallel - Flexible Parallel Subtask Delegation
#
# Purpose:
#   Delegates multiple subtasks to agents in parallel (can be different agents),
#   waits for all to complete with WebSocket monitoring.
#
# Usage:
#   cclaude-wait-parallel <task_id> <agent1> <subtask_id1> [--custom "instructions"] <agent2> <subtask_id2> [--custom "instructions"] [...]
#
# Example:
#   # Without custom instructions:
#   cclaude-wait-parallel abc-123 coding-agent sub1-uuid test-orchestrator-agent sub2-uuid
#
#   # With custom instructions per agent:
#   cclaude-wait-parallel abc-123 \
#       coding-agent sub1-uuid --custom "6) Use TypeScript strict mode 7) Add JSDoc comments" \
#       test-orchestrator-agent sub2-uuid --custom "6) Run pytest with coverage 7) Generate HTML report"
#
# Features:
#   - Launches multiple cclaude sessions in parallel (separate terminals)
#   - Each subtask can have a different agent
#   - Custom instructions per agent (optional)
#   - WebSocket monitoring for real-time progress
#   - Waits for all to complete before continuing
#   - Returns aggregated JSON results
#
# Architecture:
#   1. Parse task_id and agent/subtask/custom instruction groups
#   2. Launch all cclaude commands in parallel with &
#   3. Track all PIDs
#   4. Monitor via WebSocket multiplexer
#   5. Return aggregated results when all done
###############################################################################

set -euo pipefail

# Parse arguments
if [ $# -lt 3 ]; then
    echo "âŒ ERROR: Insufficient arguments" >&2
    echo "" >&2
    echo "Usage: cclaude-wait-parallel <task_id> <agent1> <subtask_id1> [--custom \"instructions\"] [<agent2> <subtask_id2> [--custom \"instructions\"]] [...]" >&2
    echo "" >&2
    echo "Examples:" >&2
    echo "  # Same agent for all subtasks:" >&2
    echo "  cclaude-wait-parallel abc-123 documentation-agent sub1-uuid documentation-agent sub2-uuid" >&2
    echo "" >&2
    echo "  # Different agents per subtask:" >&2
    echo "  cclaude-wait-parallel abc-123 coding-agent sub1-uuid test-orchestrator-agent sub2-uuid" >&2
    echo "" >&2
    echo "  # With custom instructions:" >&2
    echo "  cclaude-wait-parallel abc-123 \\" >&2
    echo "      coding-agent sub1-uuid --custom \"6) Use strict types 7) Add tests\" \\" >&2
    echo "      test-orchestrator-agent sub2-uuid --custom \"6) Run with coverage\"" >&2
    exit 1
fi

TASK_ID="$1"
shift 1  # Remove task_id

# Parse agent/subtask/custom instruction groups
declare -a AGENT_NAMES=()
declare -a SUBTASK_IDS=()
declare -a CUSTOM_INSTRUCTIONS=()

while [ $# -gt 0 ]; do
    if [ $# -lt 2 ]; then
        echo "âŒ ERROR: Incomplete agent/subtask pair" >&2
        exit 1
    fi

    AGENT_NAMES+=("$1")
    SUBTASK_IDS+=("$2")
    shift 2

    # Check for optional --custom parameter
    if [ $# -gt 0 ] && [ "$1" = "--custom" ]; then
        if [ $# -lt 2 ]; then
            echo "âŒ ERROR: --custom requires an argument" >&2
            exit 1
        fi
        CUSTOM_INSTRUCTIONS+=("$2")
        shift 2
    else
        CUSTOM_INSTRUCTIONS+=("")
    fi
done

SUBTASK_COUNT=${#SUBTASK_IDS[@]}

echo "ðŸš€ Parallel Subtask Delegation" >&2
echo "ðŸ“‹ Task ID: $TASK_ID" >&2
echo "ðŸ“ Subtasks: $SUBTASK_COUNT" >&2
echo "" >&2

# Show agent assignments
for i in "${!SUBTASK_IDS[@]}"; do
    if [ -n "${CUSTOM_INSTRUCTIONS[$i]}" ]; then
        echo "  [$((i+1))/$SUBTASK_COUNT] ${AGENT_NAMES[$i]} â†’ ${SUBTASK_IDS[$i]:0:8}... (custom instructions)" >&2
    else
        echo "  [$((i+1))/$SUBTASK_COUNT] ${AGENT_NAMES[$i]} â†’ ${SUBTASK_IDS[$i]:0:8}..." >&2
    fi
done

echo "" >&2

# Launch all cclaude commands in parallel
declare -a CCLAUDE_PIDS=()

for i in "${!SUBTASK_IDS[@]}"; do
    AGENT_NAME="${AGENT_NAMES[$i]}"
    SUBTASK_ID="${SUBTASK_IDS[$i]}"
    CUSTOM_INSTR="${CUSTOM_INSTRUCTIONS[$i]}"

    # Build base autonomous mode instructions
    BASE_INSTRUCTIONS="AUTONOMOUS MODE: 1) DO NOT ask user for choices 2) USE sequential-thinking tool for decisions 3) Work independently 4) UPDATE progress at 25/50/75% with progress_notes 5) COMPLETE with detailed completion_summary, testing_notes, insights_found"

    # Append custom instructions if provided
    if [ -n "$CUSTOM_INSTR" ]; then
        FULL_INSTRUCTIONS="$BASE_INSTRUCTIONS $CUSTOM_INSTR"
    else
        FULL_INSTRUCTIONS="$BASE_INSTRUCTIONS"
    fi

    # Build enhanced task description
    ENHANCED_TASK_DESC="subtask_id: $SUBTASK_ID, task_id: $TASK_ID -- $FULL_INSTRUCTIONS -- The user monitors via MCP but will NOT respond to questions - deliver complete results autonomously (agenthub_http - manage_subtask action: \"complete\" with completion_summary)."

    echo "  [$((i+1))/$SUBTASK_COUNT] Launching $AGENT_NAME for subtask $SUBTASK_ID..." >&2

    # Launch cclaude in background (opens separate terminal)
    cclaude "$AGENT_NAME" "$ENHANCED_TASK_DESC" &
    CCLAUDE_PIDS+=($!)
done

echo "" >&2
echo "âœ… All cclaude sessions launched" >&2
echo "ðŸ“Š PIDs: ${CCLAUDE_PIDS[*]}" >&2
echo "" >&2
echo "â³ Waiting for all subtasks to complete..." >&2
echo "   (You can monitor progress in the separate terminal windows)" >&2

# Wait a moment for terminals to spawn
sleep 2

# Get directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Monitor all subtasks via WebSocket multiplexer
# This provides live progress updates while waiting for completion
MAX_WAIT=3600  # max 1 hour timeout

echo "" >&2
echo "â³ Monitoring progress via WebSocket..." >&2
echo "" >&2

# Call WebSocket multiplexer with all subtask IDs
TASK_RESULT=$(python3 "$SCRIPT_DIR/poll_mcp_websocket_parallel.py" \
    "$TASK_ID" \
    --subtask-ids="${SUBTASK_IDS[*]}" \
    --timeout="$MAX_WAIT")
POLL_EXIT_CODE=$?

echo "" >&2
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&2
echo "" >&2

if [ $POLL_EXIT_CODE -eq 0 ]; then
    # All subtasks completed successfully - output JSON result
    echo "$TASK_RESULT" | python3 -m json.tool
    exit 0
else
    # Some subtasks failed or timed out
    echo "âŒ Not all subtasks completed successfully" >&2
    echo "" >&2
    echo "ðŸ“Š Status:" >&2
    echo "$TASK_RESULT" | python3 -m json.tool >&2
    echo "" >&2
    echo "ðŸ’¡ Check the terminal windows for agent output" >&2
    echo "ðŸ’¡ Use manage_subtask to check individual subtask status" >&2
    exit 1
fi
