#!/usr/bin/env bash
###############################################################################
# cclaude-wait-parallel - Simple Parallel Subtask Delegation
#
# Purpose:
#   Delegates multiple subtasks to agents in parallel, waits for all to complete.
#   NO WebSocket monitoring - just simple PID waiting like cclaude.
#
# Usage:
#   cclaude-wait-parallel <agent_name> <task_id> <subtask_id1> <subtask_id2> <subtask_id3> [...]
#
# Example:
#   cclaude-wait-parallel documentation-agent abc-123 sub1-uuid sub2-uuid sub3-uuid
#
# Features:
#   - Launches multiple cclaude sessions in parallel (separate terminals)
#   - Waits for all to complete before continuing
#   - Simple and reliable - no tokens needed!
#
# Architecture:
#   1. Launch all cclaude commands in parallel with &
#   2. Track all PIDs
#   3. Wait for each PID to complete
#   4. Report success when all done
###############################################################################

set -euo pipefail

# Parse arguments
if [ $# -lt 3 ]; then
    echo "âŒ ERROR: Insufficient arguments" >&2
    echo "" >&2
    echo "Usage: cclaude-wait-parallel <agent_name> <task_id> <subtask_id1> [subtask_id2] [...]" >&2
    echo "" >&2
    echo "Example:" >&2
    echo "  cclaude-wait-parallel documentation-agent abc-123 sub1-uuid sub2-uuid sub3-uuid" >&2
    exit 1
fi

AGENT_NAME="$1"
TASK_ID="$2"
shift 2  # Remove agent and task_id, leaving only subtask IDs

SUBTASK_IDS=("$@")
SUBTASK_COUNT=${#SUBTASK_IDS[@]}

echo "ðŸš€ Parallel Subtask Delegation" >&2
echo "ðŸ“‹ Task ID: $TASK_ID" >&2
echo "ðŸ¤– Agent: $AGENT_NAME" >&2
echo "ðŸ“ Subtasks: $SUBTASK_COUNT" >&2
echo "" >&2

# Launch all cclaude commands in parallel
declare -a CCLAUDE_PIDS=()

for i in "${!SUBTASK_IDS[@]}"; do
    SUBTASK_ID="${SUBTASK_IDS[$i]}"

    # Build enhanced task description for autonomous mode
    ENHANCED_TASK_DESC="subtask_id: $SUBTASK_ID, task_id: $TASK_ID -- AUTONOMOUS MODE: 1) DO NOT ask user for choices 2) USE sequential-thinking tool for decisions 3) Work independently 4) UPDATE progress at 25/50/75% with progress_notes 5) COMPLETE with detailed completion_summary, testing_notes, insights_found -- The user monitors via MCP but will NOT respond to questions - deliver complete results autonomously (agenthub_http - manage_subtask action: "complete" with completion_summary)."

    echo "  [$((i+1))/$SUBTASK_COUNT] Launching subtask $SUBTASK_ID..." >&2

    # Launch cclaude in background (opens separate terminal)
    cclaude "$AGENT_NAME" "$ENHANCED_TASK_DESC" &
    CCLAUDE_PIDS+=($!)
done

echo "" >&2
echo "âœ… All cclaude sessions launched" >&2
echo "ðŸ“Š PIDs: ${CCLAUDE_PIDS[*]}" >&2
echo "" >&2
echo "â³ Waiting for all subtasks to complete..." >&2
echo "   (You can monitor progress in the separate terminal windows)" >&2
# Wait a moment for terminals to spawn
sleep 2

# Get directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Monitor all subtasks via WebSocket multiplexer
# This provides live progress updates while waiting for completion
MAX_WAIT=3600  # max 1 hour timeout

echo "" >&2
echo "â³ Monitoring progress via WebSocket..." >&2
echo "" >&2

# Call WebSocket multiplexer with all subtask IDs
TASK_RESULT=$(python3 "$SCRIPT_DIR/poll_mcp_websocket_parallel.py" \
    "$TASK_ID" \
    --subtask-ids="${SUBTASK_IDS[*]}" \
    --timeout="$MAX_WAIT")
POLL_EXIT_CODE=$?

echo "" >&2
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&2
echo "" >&2

if [ $POLL_EXIT_CODE -eq 0 ]; then
    # All subtasks completed successfully - output JSON result
    echo "$TASK_RESULT" | python3 -m json.tool
    exit 0
else
    # Some subtasks failed or timed out
    echo "âŒ Not all subtasks completed successfully" >&2
    echo "" >&2
    echo "ðŸ“Š Status:" >&2
    echo "$TASK_RESULT" | python3 -m json.tool >&2
    echo "" >&2
    echo "ðŸ’¡ Check the terminal windows for agent output" >&2
    echo "ðŸ’¡ Use manage_subtask to check individual subtask status" >&2
    exit 1
fi
